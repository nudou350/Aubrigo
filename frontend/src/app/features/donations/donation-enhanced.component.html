<div class="donation-container">
  <div class="donation-header">
    <h1 class="title">Fazer uma Doa√ß√£o</h1>
    <p class="subtitle">Ajude um animal a encontrar um lar</p>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Carregando...</p>
    </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
    <mat-card class="error-card">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <p>{{ error() }}</p>
    </mat-card>
  }

  <!-- Donation Form -->
  @if (!loading()) {
    <form [formGroup]="donationForm" (ngSubmit)="submitDonation()" class="donation-form">

      <!-- ONG Selection -->
      <mat-card class="form-section">
        <h2 class="section-title">Selecione a ONG</h2>

        @if (ongs().length === 0) {
          <div class="warning-box">
            <mat-icon>info</mat-icon>
            <p>Nenhuma ONG dispon√≠vel no momento.</p>
            <p class="hint">As ONGs precisam configurar seus m√©todos de pagamento para receber doa√ß√µes.</p>
          </div>
        } @else {
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Escolha uma ONG</mat-label>
            <mat-select
              formControlName="ongId"
              (selectionChange)="onOngSelected($event.value)">
              @for (ong of ongs(); track ong.id) {
                <mat-option [value]="ong.id">
                  {{ ong.ongName }}
                  @if (ong.location) {
                    <span class="location"> - {{ ong.location }}</span>
                  }
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        }
      </mat-card>

      <!-- Donor Information (only show if ONG is selected) -->
      @if (selectedOng()) {
        <mat-card class="form-section">
          <h2 class="section-title">Informa√ß√µes do Doador</h2>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nome Completo</mat-label>
            <input matInput formControlName="donorName" placeholder="Seu nome" required>
            @if (donationForm.get('donorName')?.hasError('required') && donationForm.get('donorName')?.touched) {
              <mat-error>Nome √© obrigat√≥rio</mat-error>
            }
            @if (donationForm.get('donorName')?.hasError('minlength')) {
              <mat-error>Nome deve ter pelo menos 2 caracteres</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Email</mat-label>
            <input matInput type="email" formControlName="donorEmail" placeholder="seu@email.com" required>
            @if (donationForm.get('donorEmail')?.hasError('required') && donationForm.get('donorEmail')?.touched) {
              <mat-error>Email √© obrigat√≥rio</mat-error>
            }
            @if (donationForm.get('donorEmail')?.hasError('email')) {
              <mat-error>Email inv√°lido</mat-error>
            }
          </mat-form-field>
        </mat-card>

        <!-- Donation Details -->
        <mat-card class="form-section">
          <h2 class="section-title">Valor da Doa√ß√£o</h2>

          <mat-form-field appearance="outline" class="full-width amount-field">
            <mat-label>Valor</mat-label>
            <input matInput type="number" formControlName="amount" min="0.5" step="0.5" required>
            <span matSuffix>‚Ç¨</span>
            @if (donationForm.get('amount')?.hasError('required')) {
              <mat-error>Valor √© obrigat√≥rio</mat-error>
            }
            @if (donationForm.get('amount')?.hasError('min')) {
              <mat-error>Valor m√≠nimo: ‚Ç¨0.50</mat-error>
            }
          </mat-form-field>

          <p class="hint">Valor m√≠nimo: ‚Ç¨0.50</p>

          <div class="donation-type">
            <label class="type-label">Tipo de Doa√ß√£o:</label>
            <mat-radio-group formControlName="donationType" class="radio-group">
              <mat-radio-button value="one_time">
                <div class="radio-content">
                  <span class="radio-icon">‚ù§Ô∏è</span>
                  <div>
                    <div class="radio-title">Doa√ß√£o √önica</div>
                    <div class="radio-subtitle">Uma contribui√ß√£o pontual</div>
                  </div>
                </div>
              </mat-radio-button>
              <mat-radio-button value="monthly">
                <div class="radio-content">
                  <span class="radio-icon">üìÖ</span>
                  <div>
                    <div class="radio-title">Doa√ß√£o Mensal</div>
                    <div class="radio-subtitle">Ajuda recorrente todos os meses</div>
                  </div>
                </div>
              </mat-radio-button>
            </mat-radio-group>
          </div>
        </mat-card>

        <!-- Payment Method Selection -->
        <mat-card class="form-section">
          <h2 class="section-title">M√©todo de Pagamento</h2>

          @if (!hasAvailablePaymentMethods()) {
            <div class="warning-box">
              <mat-icon>warning</mat-icon>
              <p>Esta ONG ainda n√£o configurou m√©todos de pagamento.</p>
              <p class="hint">Por favor, selecione outra ONG.</p>
            </div>
          } @else {
            <div class="payment-methods">
              @for (method of paymentMethodOptions(); track method.value) {
                <button
                  type="button"
                  class="payment-method-button"
                  [class.selected]="selectedPaymentMethod() === method.value"
                  (click)="onPaymentMethodSelected(method.value); donationForm.patchValue({ paymentMethod: method.value })">
                  <span class="method-icon">{{ method.icon }}</span>
                  <div class="method-content">
                    <div class="method-title">{{ method.label }}</div>
                    <div class="method-subtitle">
                      @if (method.value === 'mbway') {
                        Pagamento instant√¢neo via telem√≥vel
                      } @else if (method.value === 'multibanco') {
                        Transfer√™ncia banc√°ria
                      } @else if (method.value === 'pix') {
                        Pagamento instant√¢neo
                      } @else if (method.value === 'bank_transfer') {
                        Transfer√™ncia TED/DOC
                      }
                    </div>
                  </div>
                  @if (selectedPaymentMethod() === method.value) {
                    <mat-icon class="check-icon">check_circle</mat-icon>
                  }
                </button>
              }
            </div>
          }
        </mat-card>

        <!-- Submit Button -->
        <div class="submit-section">
          <button
            mat-raised-button
            color="primary"
            type="submit"
            class="submit-button"
            [disabled]="donationForm.invalid || !selectedPaymentMethod() || loading()">
            @if (loading()) {
              <mat-spinner diameter="20"></mat-spinner>
              <span>Processando...</span>
            } @else {
              <mat-icon>favorite</mat-icon>
              <span>Continuar para Pagamento</span>
            }
          </button>
        </div>
      }
    </form>
  }

  <!-- Payment Instructions Modal -->
  @if (showInstructionsModal() && paymentInstructions()) {
    <app-payment-instructions-modal
      [instructions]="paymentInstructions()!"
      (closeModal)="closeInstructionsModal()">
    </app-payment-instructions-modal>
  }
</div>
