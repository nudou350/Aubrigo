<div class="donation-container">
  @if (currentStep() === 'form') {
    <!-- Donation Form -->
    <div class="form-section">
      <div class="form-header">
        <h1>Fazer uma Doa√ß√£o</h1>
        <p class="subtitle">Ajude um animal a encontrar um lar</p>
      </div>

      <form [formGroup]="donationForm" (ngSubmit)="onSubmit()">
        <!-- ONG Selection -->
        <div class="form-group">
          <label class="form-label">Selecione a ONG</label>
          @if (ongs().length > 0) {
            <select formControlName="ongId" class="form-input">
              <option value="" selected>Escolha uma ONG</option>
              @for (ong of ongs(); track ong.id) {
                <option [value]="ong.id">{{ ong.ongName }}</option>
              }
            </select>
            @if (getSelectedOng()) {
              <div class="selected-ong-info">
                <span class="icon">üè†</span>
                <div class="info">
                  <span class="ong-name">{{ getSelectedOng()!.ongName }}</span>
                  @if (getSelectedOng()!.location) {
                    <span class="ong-location">üìç {{ getSelectedOng()!.location }}</span>
                  }
                </div>
              </div>
            }
          } @else {
            <div class="no-ongs-message">
              <p>Nenhuma ONG dispon√≠vel no momento.</p>
            </div>
          }
          @if (donationForm.get('ongId')?.invalid && donationForm.get('ongId')?.touched) {
            <small class="error-hint">Por favor, selecione uma ONG</small>
          }
        </div>

        <!-- Donor Info -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Nome Completo</label>
            <input
              formControlName="donorName"
              type="text"
              class="form-input"
              placeholder="Seu nome">
            @if (donationForm.get('donorName')?.invalid && donationForm.get('donorName')?.touched) {
              <small class="error-hint">Nome √© obrigat√≥rio</small>
            }
          </div>

          <div class="form-group">
            <label class="form-label">Email</label>
            <input
              formControlName="donorEmail"
              type="email"
              class="form-input"
              placeholder="seu@email.com">
            @if (donationForm.get('donorEmail')?.invalid && donationForm.get('donorEmail')?.touched) {
              <small class="error-hint">Email v√°lido √© obrigat√≥rio</small>
            }
          </div>
        </div>

        <!-- Amount -->
        <div class="form-group">
          <label class="form-label">Valor da Doa√ß√£o</label>
          <div class="amount-input-wrapper">
            <span class="currency-symbol">{{ currency().symbol }}</span>
            <input
              formControlName="amount"
              type="number"
              class="form-input amount-input"
              min="0.5"
              step="0.01"
              placeholder="10.00">
            <span class="currency-code">{{ currency().code }}</span>
          </div>
          <small class="hint">Valor m√≠nimo: {{ 0.5 | currencyFormat: currency().code }}</small>
        </div>

        <!-- Donation Type -->
        <div class="form-group">
          <label class="form-label">Tipo de Doa√ß√£o</label>
          <div class="radio-group">
            <label class="radio-option" [class.selected]="donationForm.get('donationType')?.value === 'one_time'">
              <input type="radio" formControlName="donationType" value="one_time">
              <div class="radio-content">
                <span class="radio-icon">üíù</span>
                <div class="radio-text">
                  <span class="radio-title">Doa√ß√£o √önica</span>
                  <span class="radio-description">Uma contribui√ß√£o pontual</span>
                </div>
              </div>
            </label>
            <label class="radio-option" [class.selected]="donationForm.get('donationType')?.value === 'monthly'">
              <input type="radio" formControlName="donationType" value="monthly">
              <div class="radio-content">
                <span class="radio-icon">üìÖ</span>
                <div class="radio-text">
                  <span class="radio-title">Doa√ß√£o Mensal</span>
                  <span class="radio-description">Ajuda recorrente todos os meses</span>
                </div>
              </div>
            </label>
          </div>
        </div>

        <!-- Payment Method Selection -->
        <div class="form-group">
          <label class="form-label">M√©todo de Pagamento</label>
          <div class="payment-methods">
            @for (method of availablePaymentMethods(); track method.id) {
              <label
                class="payment-method-card"
                [class.selected]="selectedPaymentMethod() === method.id">
                <input type="radio" formControlName="paymentMethod" [value]="method.id">
                <div class="method-content">
                  <span class="icon material-icons">{{ method.icon }}</span>
                  <div class="method-info">
                    <span class="method-name">{{ method.name }}</span>
                    <span class="method-description">{{ method.description }}</span>
                  </div>
                </div>
              </label>
            }
          </div>
          @if (donationForm.get('paymentMethod')?.invalid && donationForm.get('paymentMethod')?.touched) {
            <small class="error-hint">Selecione um m√©todo de pagamento</small>
          }
        </div>

        <!-- Phone Number for MBWay -->
        @if (selectedPaymentMethod() === 'mbway') {
          <div class="form-group">
            <label class="form-label">N√∫mero de Telem√≥vel</label>
            <input
              formControlName="phoneNumber"
              type="tel"
              class="form-input"
              placeholder="+351912345678">
            <small class="hint">Formato: +351XXXXXXXXX</small>
            @if (donationForm.get('phoneNumber')?.invalid && donationForm.get('phoneNumber')?.touched) {
              <small class="error-hint">N√∫mero de telem√≥vel portugu√™s v√°lido √© obrigat√≥rio</small>
            }
          </div>
        }

        <!-- Submit Button -->
        <button
          type="submit"
          class="btn-primary"
          [disabled]="donationForm.invalid || isLoading()">
          @if (isLoading()) {
            <span class="spinner"></span>
            <span>Processando...</span>
          } @else {
            <span>Continuar para Pagamento</span>
            <span class="icon">‚Üí</span>
          }
        </button>
      </form>
    </div>
  }

  @if (currentStep() === 'payment' && paymentResponse()) {
    <!-- Manual PIX Payment Section -->
    @if (paymentResponse()?.payment?.pixKey) {
      <div class="payment-section">
        <button class="back-button" (click)="goBack()">
          <span class="icon">‚Üê</span>
          Voltar
        </button>

        <div class="payment-success pix-manual">
          <div class="success-icon">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </div>

          <h3>PIX - Pagamento Instantaneo</h3>
          <p class="subtitle">Complete o pagamento no aplicativo do seu banco</p>

          <!-- PIX Key Display -->
          <div class="pix-key-container">
            <div class="pix-key-label">
              Chave PIX da ONG:
              @if (paymentResponse()?.payment?.pixKeyType) {
                <span class="key-type">({{ paymentResponse()?.payment?.pixKeyType }})</span>
              }
            </div>
            <div class="pix-key-value">
              <span class="key-text">{{ paymentResponse()?.payment?.pixKey }}</span>
              <button
                type="button"
                class="btn-copy"
                (click)="copyPixKey()"
                [class.copied]="pixKeyCopied()"
              >
                @if (pixKeyCopied()) {
                  ‚úì Copiado
                } @else {
                  üìã Copiar
                }
              </button>
            </div>
          </div>

          <!-- Amount Display -->
          <div class="amount-display">
            <span class="label">Valor a transferir:</span>
            <span class="amount">{{ formatCurrency(donationForm.get('amount')?.value, donationForm.get('currency')?.value) }}</span>
          </div>

          <!-- Instructions -->
          <div class="instructions">
            <h4>Como pagar:</h4>
            <ol>
              <li>Abra o aplicativo do seu banco</li>
              <li>Selecione a opcao <strong>PIX</strong></li>
              <li>Escolha <strong>"Pagar com chave PIX"</strong></li>
              <li>Cole a chave copiada acima</li>
              <li>Insira o valor: <strong>{{ formatCurrency(donationForm.get('amount')?.value, donationForm.get('currency')?.value) }}</strong></li>
              <li>Confirme o pagamento</li>
            </ol>
          </div>

          <!-- Important Notice -->
          <div class="info-notice">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
            <div>
              <strong>Pagamento manual</strong>
              <p>
                Apos realizar o PIX, sua doacao sera confirmada automaticamente.
                Obrigado por apoiar os animais!
              </p>
            </div>
          </div>

          <button class="btn-secondary" (click)="resetForm()">
            Fazer outra doacao
          </button>
        </div>
      </div>
    } @else {
      <!-- Payment Components -->
      <div class="payment-section">
        <button class="back-button" (click)="goBack()">
          <span class="icon">‚Üê</span>
          Voltar
        </button>

        @switch (paymentResponse()!.donation.paymentMethod) {
          @case ('pix') {
            <app-pix-qr-payment
              [donationId]="paymentResponse()!.donation.id"
              [pixPaymentString]="paymentResponse()!.payment.pixPaymentString!"
              [pixQrCode]="paymentResponse()!.payment.pixQrCode"
              [amount]="paymentResponse()!.donation.amount"
              [expiresAt]="paymentResponse()!.payment.expiresAt"
              (paymentCompleted)="onPaymentCompleted()"
              (paymentExpired)="onPaymentExpired()"
              (paymentFailed)="onPaymentFailed()"
            />
          }
          @case ('boleto') {
            <app-boleto-payment
              [donationId]="paymentResponse()!.donation.id"
              [boletoUrl]="paymentResponse()!.payment.boletoUrl!"
              [boletoBarcode]="paymentResponse()!.payment.boletoBarcode!"
              [amount]="paymentResponse()!.donation.amount"
              [expiresAt]="paymentResponse()!.payment.expiresAt"
              (paymentCompleted)="onPaymentCompleted()"
              (paymentExpired)="onPaymentExpired()"
            />
          }
          @case ('multibanco') {
            <app-multibanco-payment
              [donationId]="paymentResponse()!.donation.id"
              [entity]="paymentResponse()!.payment.entity!"
              [reference]="paymentResponse()!.payment.reference!"
              [amount]="paymentResponse()!.donation.amount"
              (paymentCompleted)="onPaymentCompleted()"
            />
          }
          @case ('mbway') {
            <app-mbway-enhanced
              [donationId]="paymentResponse()!.donation.id"
              [phoneNumber]="donationForm.get('phoneNumber')!.value"
              [amount]="paymentResponse()!.donation.amount"
              (paymentCompleted)="onPaymentCompleted()"
              (paymentFailed)="onPaymentFailed()"
            />
          }
        }
      </div>
    }
  }
</div>
